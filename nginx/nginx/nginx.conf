# =========================================================
# NGINX â€“ Production Log Ingestion Gateway
# Supports multiple endpoints (/logs, /security, /metrics)
# Designed for AKS + Azure Load Balancer
# =========================================================

user nginx;

# Auto-scale workers based on CPU cores
worker_processes auto;

# Increase file descriptors for high EPS (events per second)
worker_rlimit_nofile 200000;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

# -----------------------------
# EVENT LEVEL (L4)
# -----------------------------
events {
    worker_connections 10000;   # Max concurrent connections per worker
    multi_accept on;
    use epoll;                  # Best performance on Linux
}

# -----------------------------
# HTTP (L7)
# -----------------------------
http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # -----------------------------
    # ACCESS LOG FORMAT
    # -----------------------------
    log_format main
      '$remote_addr [$time_local] "$request" '
      '$status $body_bytes_sent '
      'rt=$request_time '
      'uct=$upstream_connect_time '
      'urt=$upstream_response_time';

    access_log /var/log/nginx/access.log main;

    # -----------------------------
    # PERFORMANCE TUNING
    # -----------------------------
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;

    keepalive_timeout 65;
    keepalive_requests 10000;

    # IMPORTANT for log payloads
    client_max_body_size 100m;
    client_body_buffer_size 1m;

    # Disable buffering for streaming logs
    proxy_buffering off;

    # Hide version (security)
    server_tokens off;

    # -----------------------------
    # TLS SETTINGS
    # -----------------------------
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:50m;
    ssl_session_timeout 1d;

    # -----------------------------
    # RATE LIMITING (Protect backend)
    # -----------------------------
    # UPDATE rate if needed (EPS control)
    limit_req_zone $binary_remote_addr zone=loglimit:20m rate=300r/s;

    # -----------------------------
    # UPSTREAM BACKENDS (UPDATE THESE)
    # -----------------------------
    upstream vector_gateway {
        least_conn;
        # UPDATE service name / namespace / port
        server vector-gateway.default.svc.cluster.local:8080;
        keepalive 128;
    }

    upstream vector_security {
        least_conn;
        server vector-security.default.svc.cluster.local:8080;
        keepalive 128;
    }

    upstream vector_metrics {
        least_conn;
        server vector-metrics.default.svc.cluster.local:8080;
        keepalive 64;
    }

    # =====================================================
    # SERVER BLOCK (TLS TERMINATION)
    # =====================================================
    server {
        listen 443 ssl http2;
        server_name _;

        # TLS certs mounted from Kubernetes Secret
        ssl_certificate     /etc/nginx/tls/tls.crt;
        ssl_certificate_key /etc/nginx/tls/tls.key;

        # -----------------------------
        # HEALTH CHECK (REQUIRED for AKS)
        # -----------------------------
        location /health {
            access_log off;
            return 200 "OK\n";
        }

        # -----------------------------
        # GENERAL LOG INGESTION
        # -----------------------------
        location /logs {
            limit_req zone=loglimit burst=1000 nodelay;

            proxy_http_version 1.1;

            # Forward client identity
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;

            proxy_pass http://vector_gateway;
        }

        # -----------------------------
        # SECURITY / SIEM LOGS
        # -----------------------------
        location /security {
            limit_req zone=loglimit burst=500 nodelay;

            proxy_http_version 1.1;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;

            proxy_pass http://vector_security;
        }

        # -----------------------------
        # METRICS INGESTION
        # -----------------------------
        location /metrics {
            access_log off;
            proxy_http_version 1.1;
            proxy_pass http://vector_metrics;
        }

        # -----------------------------
        # DEFAULT DENY (SECURITY)
        # -----------------------------
        location / {
            return 404;
        }
    }
}
