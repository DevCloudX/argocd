# =========================================================
# NGINX â€“ Log Ingestion Gateway (DEV)
# Supports /logs, /security, /metrics
# AKS + Azure Load Balancer compatible
# =========================================================

user nginx;
worker_processes auto;
worker_rlimit_nofile 200000;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

# -----------------------------
# EVENT LEVEL (L4)
# -----------------------------
events {
    worker_connections 10000;
    multi_accept on;
    use epoll;
}

# -----------------------------
# HTTP (L7)
# -----------------------------
http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # -----------------------------
    # ACCESS LOG FORMAT
    # Includes namespace, pod, app
    # -----------------------------
    log_format main
      '$remote_addr [$time_local] "$request" '
      '$status $body_bytes_sent '
      'ns=$http_x_k8s_namespace '
      'pod=$http_x_k8s_pod '
      'app=$http_x_app_name '
      'rt=$request_time '
      'uct=$upstream_connect_time '
      'urt=$upstream_response_time';

    access_log /var/log/nginx/access.log main;

    # -----------------------------
    # PERFORMANCE TUNING
    # -----------------------------
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;

    keepalive_timeout 65;
    keepalive_requests 10000;

    client_max_body_size 100m;
    client_body_buffer_size 1m;

    proxy_buffering off;
    server_tokens off;

    # -----------------------------
    # TLS SETTINGS
    # -----------------------------
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:50m;
    ssl_session_timeout 1d;

    # -----------------------------
    # RATE LIMITING
    # -----------------------------
    limit_req_zone $binary_remote_addr zone=loglimit:20m rate=300r/s;

    # -----------------------------
    # UPSTREAM BACKENDS
    # -----------------------------
    upstream vector_gateway {
        least_conn;
        server vector-gateway.default.svc.cluster.local:8080;
        keepalive 128;
    }

    upstream vector_security {
        least_conn;
        server vector-security.default.svc.cluster.local:8080;
        keepalive 128;
    }

    upstream vector_metrics {
        least_conn;
        server vector-metrics.default.svc.cluster.local:8080;
        keepalive 64;
    }

    # =====================================================
    # SERVER BLOCK (TLS TERMINATION)
    # =====================================================
    server {
        listen 443 ssl http2;
        server_name _;

        ssl_certificate     /etc/nginx/tls/tls.crt;
        ssl_certificate_key /etc/nginx/tls/tls.key;

        # -----------------------------
        # HEALTH CHECK (AKS REQUIRED)
        # -----------------------------
        location /health {
            access_log off;
            return 200 "OK\n";
        }

        # -----------------------------
        # GENERAL LOG INGESTION
        # -----------------------------
        location /logs {
            limit_req zone=loglimit burst=1000 nodelay;
            proxy_http_version 1.1;

            # Source metadata (namespace logs)
            proxy_set_header X-K8s-Namespace $http_x_k8s_namespace;
            proxy_set_header X-K8s-Pod       $http_x_k8s_pod;
            proxy_set_header X-K8s-Node      $hostname;
            proxy_set_header X-App-Name      $http_x_app_name;

            # Network metadata
            proxy_set_header X-Real-IP       $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;

            proxy_pass http://vector_gateway;
        }

        # -----------------------------
        # SECURITY / SIEM LOGS
        # -----------------------------
        location /security {
            limit_req zone=loglimit burst=500 nodelay;
            proxy_http_version 1.1;

            proxy_set_header X-K8s-Namespace $http_x_k8s_namespace;
            proxy_set_header X-K8s-Pod       $http_x_k8s_pod;

            proxy_pass http://vector_security;
        }

        # -----------------------------
        # METRICS INGESTION
        # -----------------------------
        location /metrics {
            access_log off;
            proxy_http_version 1.1;

            proxy_set_header X-K8s-Namespace $http_x_k8s_namespace;

            proxy_pass http://vector_metrics;
        }

        # -----------------------------
        # DEFAULT DENY
        # -----------------------------
        location / {
            return 404;
        }
    }
}
